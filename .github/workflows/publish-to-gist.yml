name: Build and Publish to Gist

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build package
        run: npm run build
      
      - name: Create gist content
        id: gist-content
        run: |
          cd dist/public
          
          echo "Creating gist payload..."
          
          # Build files JSON using Python for better JSON handling
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          from pathlib import Path
          
          files = {}
          
          # Walk through all files in current directory
          for root, dirs, filenames in os.walk('.'):
              for filename in filenames:
                  filepath = os.path.join(root, filename)
                  # Remove leading ./
                  relative_path = filepath[2:] if filepath.startswith('./') else filepath
                  # Replace / with - for gist filename (gists don't support directories)
                  gist_filename = relative_path.replace('/', '-')
                  
                  # Read file content
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                  
                  files[gist_filename] = {"content": content}
          
          # Create the gist payload (description will be updated later)
          gist_data = {
              "description": "daily-tip",
              "public": True,
              "files": files
          }
          
          # Write to file
          with open('/tmp/gist.json', 'w') as f:
              json.dump(gist_data, f, indent=2)
          
          print(f"Gist payload created with {len(files)} files")
          PYTHON_SCRIPT
      
      - name: Create or Update Gist
        id: gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Check if token exists
          if [ -z "$GIST_TOKEN" ]; then
            echo "::error::GIST_TOKEN secret is not set!"
            exit 1
          fi
          
          echo "Token is set (first 4 chars: ${GIST_TOKEN:0:4}...)"
          
          # Look for existing gist named "daily-tip"
          echo "Searching for existing 'daily-tip' gist..."
          GISTS_RESPONSE=$(curl -s \
            -H "Authorization: Bearer $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists)
          
          GIST_ID=$(echo "$GISTS_RESPONSE" | jq -r '.[] | select(.description == "daily-tip") | .id' | head -n1)
          
          if [ -z "$GIST_ID" ] || [ "$GIST_ID" = "null" ]; then
            echo "Creating new 'daily-tip' gist..."
            
            # Update description in the JSON
            jq '.description = "daily-tip"' /tmp/gist.json > /tmp/gist-updated.json
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $GIST_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/gists \
              -d @/tmp/gist-updated.json)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ne 201 ]; then
              echo "::error::Failed to create gist. Response:"
              echo "$BODY" | jq .
              exit 1
            fi
            
            GIST_ID=$(echo "$BODY" | jq -r '.id')
            GIST_URL=$(echo "$BODY" | jq -r '.html_url')
            
            echo "gist_id=$GIST_ID" >> $GITHUB_OUTPUT
            echo "gist_url=$GIST_URL" >> $GITHUB_OUTPUT
            echo "::notice::âœ… New 'daily-tip' gist created!"
            echo "::notice::Gist ID: $GIST_ID"
            echo "::notice::Gist URL: $GIST_URL"
          else
            echo "Updating existing 'daily-tip' gist: $GIST_ID"
            
            # Update description in the JSON
            jq '.description = "daily-tip"' /tmp/gist.json > /tmp/gist-updated.json
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Authorization: Bearer $GIST_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/gists/$GIST_ID \
              -d @/tmp/gist-updated.json)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "::error::Failed to update gist. Response:"
              echo "$BODY" | jq .
              exit 1
            fi
            
            GIST_URL=$(echo "$BODY" | jq -r '.html_url')
            
            echo "gist_id=$GIST_ID" >> $GITHUB_OUTPUT
            echo "gist_url=$GIST_URL" >> $GITHUB_OUTPUT
            echo "::notice::âœ… 'daily-tip' gist updated!"
            echo "::notice::Gist URL: $GIST_URL"
          fi
          
          echo "html_preview=https://htmlpreview.github.io/?https://gist.githubusercontent.com/${{ github.repository_owner }}/$GIST_ID/raw/index.html" >> $GITHUB_OUTPUT
      
      - name: Output URLs
        run: |
          echo "::notice::ğŸ“ Gist URL: ${{ steps.gist.outputs.gist_url }}"
          echo "::notice::ğŸŒ Preview URL: ${{ steps.gist.outputs.html_preview }}"
          echo ""
          echo "View your published page at:"
          echo "${{ steps.gist.outputs.html_preview }}"
