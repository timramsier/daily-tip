name: Build and Publish to Gist

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build package
        run: npm run build
      
      - name: Create gist content
        id: gist-content
        run: |
          cd dist/public
          
          echo "Creating gist payload..."
          
          # Build files JSON using Python for better JSON handling
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          from pathlib import Path
          
          files = {}
          
          # Walk through all files in current directory
          for root, dirs, filenames in os.walk('.'):
              for filename in filenames:
                  filepath = os.path.join(root, filename)
                  # Remove leading ./
                  relative_path = filepath[2:] if filepath.startswith('./') else filepath
                  # Replace / with - for gist filename (gists don't support directories)
                  gist_filename = relative_path.replace('/', '-')
                  
                  # Read file content
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                  
                  files[gist_filename] = {"content": content}
          
          # Create the gist payload
          gist_data = {
              "description": "Daily Tip - Built from commit ${{ github.sha }}",
              "public": True,
              "files": files
          }
          
          # Write to file
          with open('/tmp/gist.json', 'w') as f:
              json.dump(gist_data, f, indent=2)
          
          print(f"Gist payload created with {len(files)} files")
          PYTHON_SCRIPT
      
      - name: Create or Update Gist
        id: gist
        run: |
          GIST_ID="${{ secrets.GIST_ID }}"
          
          if [ -z "$GIST_ID" ]; then
            echo "Creating new gist..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer ${{ secrets.GIST_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/gists \
              -d @/tmp/gist.json)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ne 201 ]; then
              echo "::error::Failed to create gist. Response:"
              echo "$BODY" | jq .
              exit 1
            fi
            
            GIST_ID=$(echo "$BODY" | jq -r '.id')
            GIST_URL=$(echo "$BODY" | jq -r '.html_url')
            
            echo "gist_id=$GIST_ID" >> $GITHUB_OUTPUT
            echo "gist_url=$GIST_URL" >> $GITHUB_OUTPUT
            echo "::notice::âœ… New Gist created!"
            echo "::notice::Gist ID: $GIST_ID"
            echo "::notice::Gist URL: $GIST_URL"
            echo "::notice::ğŸ’¡ Add GIST_ID=$GIST_ID as a secret to update the same gist in future runs"
          else
            echo "Updating existing gist: $GIST_ID"
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GIST_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/gists/$GIST_ID \
              -d @/tmp/gist.json)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "::error::Failed to update gist. Response:"
              echo "$BODY" | jq .
              exit 1
            fi
            
            GIST_URL=$(echo "$BODY" | jq -r '.html_url')
            
            echo "gist_id=$GIST_ID" >> $GITHUB_OUTPUT
            echo "gist_url=$GIST_URL" >> $GITHUB_OUTPUT
            echo "::notice::âœ… Gist updated!"
            echo "::notice::Gist URL: $GIST_URL"
          fi
          
          echo "html_preview=https://htmlpreview.github.io/?https://gist.githubusercontent.com/${{ github.repository_owner }}/$GIST_ID/raw/index.html" >> $GITHUB_OUTPUT
      
      - name: Output URLs
        run: |
          echo "::notice::ğŸ“ Gist URL: ${{ steps.gist.outputs.gist_url }}"
          echo "::notice::ğŸŒ Preview URL: ${{ steps.gist.outputs.html_preview }}"
          echo ""
          echo "View your published page at:"
          echo "${{ steps.gist.outputs.html_preview }}"
